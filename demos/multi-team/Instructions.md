# Multi-team Global External Gateway demo
 Please note that this is **not** an official resource, so please refer to the documentation on GKE Autopilot on Google Cloud's official site.

Please run the buildplatform.sh script before processing. Follow the instructions in the readme file.

## Connect to your cluster
```sh
env PROJECT_ID=<project id>
```

```sh
gcloud config set project $PROJECT_ID

source infra/vars.sh

gcloud container clusters get-credentials ${GKE_PROD2_NAME} \
--zone ${GKE_PROD2_LOCATION} --project ${PROJECT_ID}
```

## Ensure Gateway API is installed on the cluster. 
This demo uses the regional external loadbalancer class.
First, ensure that Gateway API is enabled on the cluster by following [these](https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-gateways#enable-gateway) instructions.

## Create a static ip address to be used for the gateway
```sh
cd demos/multi-team/platform/terraform
terraform init -backend-config="bucket=${PROJECT_ID}"
terraform plan -out=tfplan
```
Verify the infrastructure is according to plan. If so, proceed to the next step.

```sh
terraform apply tfplan
```
Take note of the IP Address generated by the terraform module.

## Deploy the gateway in the cluster
The gateway is deployed in its own namespace, in this case the *single-cluster-gateway* namespace. 
The gateway uses the class *gke-l7-global-external-managed*. 
And listens to any connections coming into port 80.
Routes (we'll see later) that are deployed into namespaces that contain the label *single-cluster-gateway: "true"* are namespaces from which routes are allowed to be created on this gateway.

This way, the *single-cluster-gateway* namespace remains under the control of the platform team, while application teams can deploy httproutes in their own namespaces.

The platform team can also ensure that only certain namespaces can contain the label.

```sh
kind: Gateway
apiVersion: gateway.networking.k8s.io/v1beta1
metadata:
  name: external-http-single-cluster
  namespace: single-cluster-gateway
spec:
  gatewayClassName: gke-l7-global-external-managed
  listeners:
  - name: http
    protocol: HTTP
    port: 80
    allowedRoutes:
      namespaces:
        from: Selector
        selector:
          matchLabels:
            single-cluster-gateway: "true"
  addresses:
  - type: NamedAddress
    value: single-cluster-gateway-address
```
Let's deploy this gateway.

```sh
cd ..
kubectl apply -f ./k8s
```
Watch the gateway get deployed.
```sh
kubens single-cluster-gateway
kubectl describe gtw/external-http-single-cluster
```
This command should give you the events that take place to program a gateway and attach a loadbalancer. The gateway when "PROGRAMMED" is ready to use. But, we will need httproutes.
